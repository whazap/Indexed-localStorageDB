/*!
Kailash Nadh (http://kailashnadh.name)
Del Bianco Luca <vshjxyz@gmail.com>
Sebastian Herber (minor updates/fixes)

Indexed-localStorageDB 1.0.0
2013-08-29
A simple database layer for localStorage with indexes

License: MIT License
*/
function localStorageDB(v){var h="db_",r=h+v,t=false,B=null;B=localStorage[r];if(!(B&&(B=JSON.parse(B))&&B.tables&&B.data)){if(!g(v)){x("The name '"+v+"' contains invalid characters.")}else{B={tables:{},data:{}};n();t=true}}function m(){delete localStorage[r];B=null}function s(){var E=0;for(var D in B.tables){if(B.tables.hasOwnProperty(D)){E++}}return E}function f(D){return B.tables[D]?true:false}function e(D){if(!f(D)){x("The table '"+D+"' does not exist.")}}function k(E,D,F){var H={};for(var G=0;G<F.length;G++){H[F[G]]={}}B.tables[E]={fields:D,auto_increment:1,indexes:H};B.data[E]={}}function y(G,I,H){var K,M,L,F,D=false,J,E;if(G&&B.tables[G]){if(I){L={};for(F=0;F<I.length;F++){L[I[F]]=true}delete L.ID;I=["ID"];for(M in L){if(L.hasOwnProperty(M)){I.push(M)}}K=B.tables[G].fields;for(F=0,J=I.length;F<J;++F){if(!K.contains(I[F])){D=true;break}}if(!D){for(F=0,J=K.length;F<J;++F){if(!I.contains(K[F])){D=true;break}}}if(D){B.tables[G].fields=I}}if(H){E={};for(F=0;F<H.length;F++){E[H[F]]={}}B.tables[G].indexes=I}n()}}function z(D){delete B.tables[D];delete B.data[D]}function d(D){B.tables[D].auto_increment=1;B.data[D]={}}function q(E){var F=0;for(var D in B.data[E]){if(B.data[E].hasOwnProperty(D)){F++}}return F}function a(D,F){F.ID=B.tables[D].auto_increment;B.data[D][B.tables[D].auto_increment]=F;B.tables[D].auto_increment++;for(var E in B.tables[D].indexes){if(F.hasOwnProperty(E)){if(B.tables[D].indexes[E][F[E]]===undefined){B.tables[D].indexes[E][F[E]]=[]}if(B.tables[D].indexes[E][F[E]].indexOf(F.ID)==-1){B.tables[D].indexes[E][F[E]].push(F.ID)}}}return F.ID}function C(D){return B.tables[D].auto_increment}function u(E,H){var D=null,G=[],I=null;for(var F=0;F<H.length;F++){D=H[F];I=B.data[E][D];G.push(A(I))}return G}function c(I,H,E){var J=[],N=false,O=null;var M=[];var D=false;for(var G in B.tables[I].indexes){if(H.hasOwnProperty(G)&&B.tables[I].indexes[G].hasOwnProperty(H[G])){D=true;for(var F=0;F<B.tables[I].indexes[G][H[G]].length;F++){M[B.tables[I].indexes[G][H[G]][F]]=null}}}if(M.length==0&&(!D)){M=B.data[I]}for(var K in M){if(!B.data[I].hasOwnProperty(K)){continue}O=B.data[I][K];N=false;for(var L in H){if(!H.hasOwnProperty(L)){continue}if(typeof H[L]=="string"){if(O[L]&&(O[L].toString().toLowerCase()==H[L].toString().toLowerCase())){N=true;break}}else{if(O[L]==H[L]){N=true;break}}}if(N){J.push(K)}if(J.length==E){break}}return J}function p(G,F,E){var H=[],I=false,J=null;for(var D in B.data[G]){if(!B.data[G].hasOwnProperty(D)){continue}J=B.data[G][D];if(F(A(J))==true){H.push(D)}if(H.length==E){break}}return H}function l(F,E){var G=[];for(var D in B.data[F]){if(B.data[F].hasOwnProperty(D)){G.push(D);if(G.length==E){break}}}return G}function i(D,G){for(var F=0;F<G.length;F++){for(var H in B.data[D][G[F]]){if(B.tables[D].indexes.hasOwnProperty(H)){var E=B.tables[D].indexes[H][B.data[D][G[F]][H]].indexOf(Number(G[F]));if(E>-1){delete B.tables[D].indexes[H][B.data[D][G[F]][H]][E]}}}if(B.data[D].hasOwnProperty(G[F])){delete B.data[D][G[F]]}}return G.length}function o(J,E,H){var K="",I=0;for(var G=0;G<E.length;G++){K=E[G];var D=H(A(B.data[J][K]));if(D){delete D.ID;var L=B.data[J][K];for(var F in B.tables[J].indexes){if(D.hasOwnProperty(F)){delete B.tables[J].indexes[F][L[F]][K];B.tables[J].indexes[F][D[F]][K]=null}}for(var M in D){if(D.hasOwnProperty(M)){L[M]=D[M]}}B.data[J][K]=j(J,L);I++}}return I}function n(){localStorage[r]=JSON.stringify(B)}function w(){return JSON.stringify(B)}function x(D){throw new Error(D)}function A(E){var F={};for(var D in E){if(E.hasOwnProperty(D)){F[D]=E[D]}}return F}function g(D){return D.match(/[^a-z_0-9]/ig)?false:true}function j(E,G){var H="",D={};for(var F=0;F<B.tables[E].fields.length;F++){H=B.tables[E].fields[F];if(typeof G[H]!=="undefined"){D[H]=G[H]}}return D}function b(E,G){var H="",D={};for(var F=0;F<B.tables[E].fields.length;F++){H=B.tables[E].fields[F];D[H]=(typeof G[H]!=="undefined")?G[H]:null}return D}return{commit:function(){n()},isNew:function(){return t},drop:function(){m()},serialize:function(){return w()},tableExists:function(D){return f(D)},tableCount:function(){return s()},createTable:function(F,H,G){var L=false;if(G===undefined){G=[]}if(!g(F)){x("The database name '"+F+"' contains invalid characters.")}else{if(this.tableExists(F)){x("The table name '"+F+"' already exists.")}else{var K=true;for(var E=0;E<H.length;E++){if(!g(H[E])){K=false;break}}for(var D=0;D<G.length;D++){if(H.indexOf(G[D])<0){x('The index "'+G[D]+'" does not bind with any field in the table')}}if(K){var I={};for(var E=0;E<H.length;E++){I[H[E]]=true}delete I.ID;H=["ID"];for(var J in I){if(I.hasOwnProperty(J)){H.push(J)}}k(F,H,G);L=true}else{x("One or more field names in the table definition contains invalid characters.")}}}return L},updateTable:function(E,D,F){y(E,D,F)},dropTable:function(D){e(D);z(D)},truncate:function(D){e(D);d(D)},rowCount:function(D){e(D);return q(D)},insert:function(D,E){e(D);return a(D,b(D,E))},getAutoIncrementValue:function(D){return C(D)},update:function(D,G,E){e(D);var F=[];if(!G){F=l(D)}else{if(typeof G=="object"){F=c(D,j(D,G))}else{if(typeof G=="function"){F=p(D,G)}}}return o(D,F,E)},query:function(E,G,D){e(E);var F=[];if(!G){F=l(E,D)}else{if(typeof G=="object"){F=c(E,j(E,G),D)}else{if(typeof G=="function"){F=p(E,G,D)}}}return u(E,F,D)},deleteRows:function(D,F){e(D);var E=[];if(!F){E=l(D)}else{if(typeof F=="object"){E=c(D,j(D,F))}else{if(typeof F=="function"){E=p(D,F)}}}return i(D,E)}}}if(!Array.prototype.indexOf){Array.prototype.indexOf=function(d,c){if(c==null){c=0}else{if(c<0){c=Math.max(0,this.length+c)}}for(var b=c,a=this.length;b<a;b++){if(this[b]===d){return b}}return -1}};