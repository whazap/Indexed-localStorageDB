/*!
 Kailash Nadh (http://kailashnadh.name)
 Del Bianco Luca <vshjxyz@gmail.com>

 Indexed-localStorageDB 1.0.0
 2013-08-29
 A simple database layer for localStorage with indexes

 License: MIT License
*/
function localStorageDB(a){function b(){delete localStorage[A],C=null}function c(){var a=0;for(var b in C.tables)C.tables.hasOwnProperty(b)&&a++;return a}function d(a){return C.tables[a]?!0:!1}function e(a){d(a)||u("The table '"+a+"' does not exist.")}function f(a,b,c){for(var d={},e=0;e<c.length;e++)d[c[e]]={};C.tables[a]={fields:b,auto_increment:1,indexes:d},C.data[a]={}}function g(a,b,c){var d,e,f,g,h,i,j=!1;if(a&&C.tables[a]){if(b){for(f={},g=0;g<b.length;g++)f[b[g]]=!0;delete f.ID,b=["ID"];for(e in f)f.hasOwnProperty(e)&&b.push(e);for(d=C.tables[a].fields,g=0,h=b.length;h>g;++g)if(!d.contains(b[g])){j=!0;break}if(!j)for(g=0,h=d.length;h>g;++g)if(!b.contains(d[g])){j=!0;break}j&&(C.tables[a].fields=b)}if(c){for(i={},g=0;g<c.length;g++)i[c[g]]={};C.tables[a].indexes=b}s()}}function h(a){delete C.tables[a],delete C.data[a]}function i(a){C.tables[a].auto_increment=1,C.data[a]={}}function j(a){var b=0;for(var c in C.data[a])C.data[a].hasOwnProperty(c)&&b++;return b}function k(a,b){b.ID=C.tables[a].auto_increment,C.data[a][C.tables[a].auto_increment]=b,C.tables[a].auto_increment++;for(var c in C.tables[a].indexes)b.hasOwnProperty(c)&&(void 0===C.tables[a].indexes[c][b[c]]&&(C.tables[a].indexes[c][b[c]]=[]),-1==C.tables[a].indexes[c][b[c]].indexOf(b.ID)&&C.tables[a].indexes[c][b[c]].push(b.ID));return b.ID}function l(a){return C.tables[a].auto_increment}function m(a,b){for(var c=null,d=[],e=null,f=0;f<b.length;f++)c=b[f],e=C.data[a][c],d.push(v(e));return d}function n(a,b,c){var d=[],e=!1,f=null,g=[],h=!1;for(var i in C.tables[a].indexes)if(b.hasOwnProperty(i)&&C.tables[a].indexes[i].hasOwnProperty(b[i])){h=!0;for(var j=0;j<C.tables[a].indexes[i][b[i]].length;j++)g[C.tables[a].indexes[i][b[i]][j]]=null}0!=g.length||h||(g=C.data[a]);for(var k in g)if(C.data[a].hasOwnProperty(k)){f=C.data[a][k],e=!1;for(var l in b)if(b.hasOwnProperty(l))if("string"==typeof b[l]){if(f[l]&&f[l].toString().toLowerCase()==b[l].toString().toLowerCase()){e=!0;break}}else if(f[l]==b[l]){e=!0;break}if(e&&d.push(k),d.length==c)break}return d}function o(a,b,c){var d=[],e=null;for(var f in C.data[a])if(C.data[a].hasOwnProperty(f)&&(e=C.data[a][f],1==b(v(e))&&d.push(f),d.length==c))break;return d}function p(a,b){var c=[];for(var d in C.data[a])if(C.data[a].hasOwnProperty(d)&&(c.push(d),c.length==b))break;return c}function q(a,b){for(var c=0;c<b.length;c++){for(var d in C.data[a][b[c]])if(C.tables[a].indexes.hasOwnProperty(d)){var e=C.tables[a].indexes[d][C.data[a][b[c]][d]].indexOf(Number(b[c]));e>-1&&delete C.tables[a].indexes[d][C.data[a][b[c]][d]][e]}C.data[a].hasOwnProperty(b[c])&&delete C.data[a][b[c]]}return b.length}function r(a,b,c){for(var d="",e=0,f=0;f<b.length;f++){d=b[f];var g=c(v(C.data[a][d]));if(g){delete g.ID;var h=C.data[a][d];for(var i in C.tables[a].indexes)g.hasOwnProperty(i)&&(delete C.tables[a].indexes[i][h[i]][d],C.tables[a].indexes[i][g[i]][d]=null);for(var j in g)g.hasOwnProperty(j)&&(h[j]=g[j]);C.data[a][d]=x(a,h),e++}}return e}function s(){localStorage[A]=JSON.stringify(C)}function t(){return JSON.stringify(C)}function u(a){throw new Error(a)}function v(a){var b={};for(var c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b}function w(a){return a.match(/[^a-z_0-9]/gi)?!1:!0}function x(a,b){for(var c="",d={},e=0;e<C.tables[a].fields.length;e++)c=C.tables[a].fields[e],"undefined"!=typeof b[c]&&(d[c]=b[c]);return d}function y(a,b){for(var c="",d={},e=0;e<C.tables[a].fields.length;e++)c=C.tables[a].fields[e],d[c]="undefined"!=typeof b[c]?b[c]:null;return d}var z="db_",A=z+a,B=!1,C=null;return C=localStorage[A],C&&(C=JSON.parse(C))&&C.tables&&C.data||(w(a)?(C={tables:{},data:{}},s(),B=!0):u("The name '"+a+"'"+" contains invalid characters.")),{commit:function(){s()},isNew:function(){return B},drop:function(){b()},serialize:function(){return t()},tableExists:function(a){return d(a)},tableCount:function(){return c()},createTable:function(a,b,c){var d=!1;if(void 0===c&&(c=[]),w(a))if(this.tableExists(a))u("The table name '"+a+"' already exists.");else{for(var e=!0,g=0;g<b.length;g++)if(!w(b[g])){e=!1;break}for(var h=0;h<c.length;h++)b.indexOf(c[h])<0&&u('The index "'+c[h]+'" does not bind with any field in the table');if(e){for(var i={},g=0;g<b.length;g++)i[b[g]]=!0;delete i.ID,b=["ID"];for(var j in i)i.hasOwnProperty(j)&&b.push(j);f(a,b,c),d=!0}else u("One or more field names in the table definition contains invalid characters.")}else u("The database name '"+a+"'"+" contains invalid characters.");return d},updateTable:function(a,b,c){g(a,b,c)},dropTable:function(a){e(a),h(a)},truncate:function(a){e(a),i(a)},rowCount:function(a){return e(a),j(a)},insert:function(a,b){return e(a),k(a,y(a,b))},getAutoIncrementValue:function(a){return l(a)},update:function(a,b,c){e(a);var d=[];return b?"object"==typeof b?d=n(a,x(a,b)):"function"==typeof b&&(d=o(a,b)):d=p(a),r(a,d,c)},query:function(a,b,c){e(a);var d=[];return b?"object"==typeof b?d=n(a,x(a,b),c):"function"==typeof b&&(d=o(a,b,c)):d=p(a,c),m(a,d,c)},deleteRows:function(a,b){e(a);var c=[];return b?"object"==typeof b?c=n(a,x(a,b)):"function"==typeof b&&(c=o(a,b)):c=p(a),q(a,c)}}}Array.prototype.indexOf||(Array.prototype.indexOf=function(a,b){null==b?b=0:0>b&&(b=Math.max(0,this.length+b));for(var c=b,d=this.length;d>c;c++)if(this[c]===a)return c;return-1});